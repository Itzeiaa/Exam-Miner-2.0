<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Test Gemini PHP (Image → base64)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    label { font-weight: 600; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; background:#111827; color:#fff; }
    #preview { max-width: 320px; max-height: 240px; border:1px solid #ddd; border-radius:8px; object-fit: contain; }
    textarea { width: 100%; min-height: 160px; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    input[type="text"] { padding:8px; border:1px solid #ddd; border-radius:8px; min-width: 320px; }
    .hint { color:#6b7280; font-size:0.9em; }
    .divider { height:1px; background:#eee; margin:16px 0; }
  </style>
</head>
<body>
  <h1>Gemini PHP Tester (Upload → base64 → describe)</h1>

  <div class="row">
    <input id="file" type="file" accept="image/*">
    <button id="send" disabled>Send to PHP</button>
  </div>

  <div class="row">
    <label for="prompt">Prompt</label>
    <input id="prompt" type="text" value="Describe this image in 3–5 concise bullets. Then add 5 short tags." />
  </div>

  <div class="row">
    <img id="preview" alt="Preview will appear here">
  </div>

  <div class="divider"></div>

  <label for="b64">Client-side base64 (for your checking)</label>
  <textarea id="b64" placeholder="Base64 will appear here after you pick an image..."></textarea>

  <div class="divider"></div>

  <label for="out">PHP / Gemini Response</label>
  <textarea id="out" placeholder="Server response will appear here..."></textarea>

  <p class="hint">
    Server must have your GEMINI_API_KEY set (environment variable). For testing only.
  </p>

  <script>
    const fileEl = document.getElementById('file');
    const sendBtn = document.getElementById('send');
    const b64El = document.getElementById('b64');
    const outEl = document.getElementById('out');
    const previewEl = document.getElementById('preview');
    const promptEl = document.getElementById('prompt');

    let fileBlob = null;

    fileEl.addEventListener('change', async () => {
      const f = fileEl.files?.[0];
      fileBlob = f || null;
      sendBtn.disabled = !fileBlob;
      outEl.value = '';
      b64El.value = '';

      if (f) {
        const url = URL.createObjectURL(f);
        previewEl.src = url;

        // Convert to base64 (client-side) so you can verify
        const dataURL = await toDataURL(f);
        const base64 = dataURL.split(';base64,')[1];
        b64El.value = base64;
      } else {
        previewEl.removeAttribute('src');
      }
    });

    sendBtn.addEventListener('click', async () => {
      if (!fileBlob) return alert('Please choose an image first');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Working...';
      outEl.value = 'Uploading to PHP and calling Gemini...';

      try {
        const fd = new FormData();
        fd.append('image', fileBlob);
        fd.append('prompt', promptEl.value);
        // Optional: choose model
        fd.append('model', 'gemini-2.5-flash');

        const res = await fetch('describe.php', { method: 'POST', body: fd });
        const json = await res.json();

        if (!res.ok || json.ok === false) {
          throw new Error(json.error || `HTTP ${res.status}`);
        }

        // Show what PHP returned (Gemini text + server-side base64 copy)
        outEl.value =
          `--- Gemini Text ---\n${json.text}\n\n` +
          `--- Server base64 echo (first 200 chars) ---\n${(json.base64 || '').slice(0,200)}...`;
      } catch (err) {
        outEl.value = 'Error: ' + (err.message || err);
      } finally {
        sendBtn.textContent = 'Send to PHP';
        sendBtn.disabled = false;
      }
    });

    function toDataURL(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
